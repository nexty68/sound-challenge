<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sound Challenge</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Ton CSS inchangé… */
  </style>
</head>
<body>
  <!-- Pseudo -->
  <div id="join-screen" style="position:fixed;…">…</div>

  <!-- Jeu -->
  <div id="game" style="display:none">
    <div class="container">
      <!-- Scoreboard -->
      <div id="scoreboard">…</div>

      <!-- Média à imiter -->
      <div class="current-media">…</div>

      <!-- Enregistrement -->
      <div class="recorder-section">…</div>

      <!-- Vote -->
      <div class="voting-section">…</div>

      <!-- Séquence -->
      <div id="sequence-playback" style="display:none;text-align:center;margin-bottom:30px">
        <h2 class="section-title"><i class="fas fa-play-circle"></i> Relecture des imitations</h2>
        <!-- compteur + barre -->
        <div id="seq-progress" style="margin-bottom:8px;font-weight:600">0/0</div>
        <progress id="seq-bar" value="0" max="0"
                  style="width:80%;max-width:600px;height:8px;margin-bottom:15px"></progress>
        <!-- nom + audio -->
        <div>
          <div id="seq-player-name" style="font-size:1.5rem;margin-bottom:10px">–</div>
          <audio id="seq-audio" controls style="width:80%;max-width:600px"></audio>
        </div>
      </div>

      <!-- Résultats -->
      <div id="results-section" class="results-section">…</div>

      <!-- Media Manager + Instructions -->
      <div class="media-manager">…</div>
      <div class="instructions">…</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM refs…
      const joinScreen       = document.getElementById('join-screen');
      const game             = document.getElementById('game');
      const joinBtn          = document.getElementById('join-btn');
      const nameInput        = document.getElementById('name-input');
      const recordBtn        = document.getElementById('recordBtn');
      const playBtn          = document.getElementById('playBtn');
      const submitBtn        = document.getElementById('submitBtn');
      const visualizer       = document.getElementById('visualizer');
      const recIndicator     = document.getElementById('recIndicator');
      const timerElem        = document.getElementById('timer');
      const mediaTitle       = document.getElementById('media-title');
      const originalAudio    = document.getElementById('original-audio');
      const videoPlayer      = document.getElementById('video-player');
      const mediaList        = document.getElementById('media-list');
      const playersContainer = document.getElementById('players-container');
      const votingStatus     = document.getElementById('voting-status');
      const showOriginalBtn  = document.getElementById('showOriginalBtn');
      const playAllBtn       = document.getElementById('playAllBtn');
      const endRoundBtn      = document.getElementById('endRoundBtn');
      const nextRoundBtn     = document.getElementById('nextRoundBtn');
      const sequencePlayback = document.getElementById('sequence-playback');
      const seqProgress      = document.getElementById('seq-progress');
      const seqBar           = document.getElementById('seq-bar');
      const seqName          = document.getElementById('seq-player-name');
      const seqAudio         = document.getElementById('seq-audio');
      const resultsSection   = document.getElementById('results-section');
      const winnerNameElem   = document.getElementById('winner-name');
      const winnerVotesElem  = document.getElementById('winner-votes');
      const winnerAudio      = document.getElementById('winner-audio');
      const scoreList        = document.getElementById('score-list');
      const scoreboard       = document.getElementById('scoreboard');

      // State
      let socket;
      let recorder, recordedChunks = [], mediaURL;
      let mediaLibrary = [], playersData = {};
      let hasVoted = false, voteCompleted = false;
      let scores = {};
      let isHost = false;
      let sequenceItems = [];
      let seqIndex = 0;

      // Visualizer funcs…
      function initVisualizer(){…}
      function animateBars(){…}

      // Media list funcs…
      function renderMediaList(){…}
      function loadMedia(i){…}

      // Players + vote UI…
      function renderPlayers(){…}

      // Scoreboard…
      function renderScoreboard(){…}

      // Recorder handlers…
      recordBtn.onclick = ()=>{/*…*/};
      playBtn.onclick   = ()=>{/*…*/};
      submitBtn.onclick = ()=>{/*…*/};

      // Playback controls…
      showOriginalBtn.onclick = ()=>{/*…*/};
      playAllBtn.onclick       = ()=>{/*…*/};
      endRoundBtn.onclick      = ()=>{/*…*/};
      nextRoundBtn.onclick     = ()=>{/*…*/};

      // MediaRecorder setup…
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream=>{/*…*/})
        .catch(err=>alert('Micro inaccessible : '+err.message));

      // Socket.IO
      joinBtn.onclick = () => {
        const name = nameInput.value.trim();
        if(!name) return alert('Entrer un pseudo');
        joinScreen.style.display = 'none';
        game.style.display       = 'block';
        socket = io();

        socket.on('isHost', b=>{ isHost=b; });

        let room = location.pathname.split('/').pop()||'main';
        socket.emit('join',{room,name});

        socket.on('mediaLibrary', lib=>{
          mediaLibrary = lib;
          renderMediaList();
        });
        // NEW: load the current media
        socket.on('newMedia', ({index,media})=>{
          loadMedia(index);
        });

        socket.on('players', pd=>{
          playersData = pd;
          Object.keys(pd).forEach(n=>scores[n]=scores[n]||0);
          renderPlayers();
          renderScoreboard();
        });

        socket.on('playPlayback', ({url,type})=>{
          if(type==='audio') new Audio(url).play();
          else{/*…*/}
        });

        // ROUND ENDED
        socket.on('roundEnded', ({winner,players})=>{
          voteCompleted=true;
          // accumulate nets
          Object.entries(players).forEach(([n,p])=>{
            scores[n]=(scores[n]||0)+p.net;
          });
          renderScoreboard();
          winnerNameElem.textContent=winner;
          winnerVotesElem.textContent=players[winner].net;
          winnerAudio.src=players[winner].audio;
          winnerAudio.style.display='block';
          resultsSection.style.display='block';

          // prepare sequence UI
          sequenceItems = Object.entries(players)
            .filter(([,p])=>p.submitted)
            .map(([n,p])=>({name:n,url:p.audio}));
          seqIndex=0;
          seqProgress.textContent = `0/${sequenceItems.length}`;
          seqBar.max      = sequenceItems.length;
          seqBar.value    = 0;
          sequencePlayback.style.display='block';
          resultsSection.style.display='none';

          // trigger server‐driven replay
          // host click or auto‐emit?
        });

        // PLAY ONE IMITATION
        socket.on('playOneImitation', ({name,url})=>{
          seqIndex++;
          seqProgress.textContent = `${seqIndex}/${sequenceItems.length}`;
          seqBar.value            = seqIndex;
          seqName.textContent     = name;
          seqAudio.src            = url;
          seqAudio.load();
          seqAudio.play().catch(()=>{});
        });

        // ROUND STARTED
        socket.on('roundStarted', ()=>{
          voteCompleted=false;
          hasVoted=false;
          resultsSection.style.display='none';
          sequencePlayback.style.display='none';
          playAllBtn.style.display='none';
          playBtn.disabled=true;
          submitBtn.disabled=true;
          endRoundBtn.style.display=isHost?'inline-block':'none';
          nextRoundBtn.style.display='none';
        });
      };
    });
  </script>
</body>
</html>
